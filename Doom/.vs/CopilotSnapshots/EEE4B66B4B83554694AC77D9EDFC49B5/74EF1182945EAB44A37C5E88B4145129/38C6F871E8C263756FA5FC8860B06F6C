using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Doom
{
    internal class Game
    {
        static Random RNG = new Random();
        public Player Player { get; }
        public bool Exited { get; set; }

        public List<GameItem> Items { get; set; }
        public List<Demon> Demons { get; set; }

        public Game()
        {
            this.Player = new Player(0, 0);
            this.Exited = false;
            this.Items = new List<GameItem>();
            this.Demons = new List<Demon>();
        }

        private void RenderSingleSprite(ConsoleSprite sprite, Position pos)
        {
            if (pos.PosX < 0 ||
                pos.PosY < 0 ||
                pos.PosX >= Console.WindowWidth || 
                pos.PosY >= Console.WindowHeight)
            {
                return;
            }
            Console.BackgroundColor = sprite.Background;
            Console.ForegroundColor = sprite.ForeGround;
            Console.SetCursorPosition(pos.PosX, pos.PosY);
            Console.WriteLine(sprite.Symbol);
        }

        private void RenderGame()
        {
            Console.CursorVisible = false;
            Console.ResetColor();
            Console.Clear();
            for (int i = 0; i < this.Items.Count; i++)
            {
                RenderSingleSprite(this.Items[i].ItemSprite, this.Items[i].ItemPos);
            }
            for (int i = 0; i < this.Demons.Count; i++)
            {
                RenderSingleSprite(this.Demons[i].Sprite, this.Demons[i].Pos);
            }
            RenderSingleSprite(this.Player.Sprite, this.Player.Pos);
        }

        private void UserAction()
        {
            if (Console.KeyAvailable)
            {
                ConsoleKeyInfo keyInfo = Console.ReadKey(true);
                int newX = this.Player.Pos.PosX;
                int newY = this.Player.Pos.PosY;

                switch (keyInfo.Key)
                {
                    case ConsoleKey.Escape:
                        this.Exited = true;
                        break;
                    case ConsoleKey.W:
                        newY -= 1;
                        break;
                    case ConsoleKey.S:
                        newY += 1;
                        break;
                    case ConsoleKey.A:
                        newX -= 1;
                        break;
                    case ConsoleKey.D:
                        newX += 1;
                        break;
                    case ConsoleKey.E:
                        List<GameItem> nearbyItems = GetGameItemsWithinDistance(this.Player.Pos, 1);
                        foreach (var item in nearbyItems)
                        {
                            item.Interact(this.Player);
                        }
                        break;
                }

                if (newX >= 0 && newX < Console.WindowWidth &&
                    newY >= 0 && newY < Console.WindowHeight - 1)
                {
                    Move(this.Player, new Position(newX, newY));
                }
            }
        }

        private void CleanUpDemons()
        {
            List<Demon> demonsToRemove = new List<Demon>();
            foreach (var demon in this.Demons)
            {
                if (!demon.Alive)
                {
                    demonsToRemove.Add(demon);
                }
            }
            foreach (var demon in demonsToRemove)
            {
                this.Demons.Remove(demon);
            }
        }
        private void CleanUpGameItems()
        {
            List<GameItem> itemsToRemove = new List<GameItem>();
            foreach (var item in this.Items)
            {
                if (!item.Avalaible)
                {
                    itemsToRemove.Add(item);
                }
            }
            foreach (var item in itemsToRemove)
            {
                this.Items.Remove(item);
            }
        }

        private List<Demon> GetDemonsWithinDistance(Position Pos, double distance)
        {
            List<Demon> nearbyDemons = new List<Demon>();
            foreach (var demon in this.Demons)
            {
                double dist = Position.Distance(Pos, demon.Pos);
                if (dist <= distance)
                {
                    nearbyDemons.Add(demon);
                }
            }
            return nearbyDemons;
        }
        private List<GameItem> GetGameItemsWithinDistance(Position Pos, double distance)
        {
            List<GameItem> nearbyItems = new List<GameItem>();
            foreach (var item in this.Items)
            {
                double dist = Position.Distance(Pos, item.ItemPos);
                if (dist <= distance)
                {
                    nearbyItems.Add(item);
                }
            }

            return nearbyItems;
        }

        private double GetTotalFillingRatio(Position Pos)
        {
            List<GameItem> items = GetGameItemsWithinDistance(Pos, 0.0);
            List<Demon> demons = GetDemonsWithinDistance(Pos, 0.0);
            double totalFillingRatio = 0.0;
            foreach (var item in items)
            {
                totalFillingRatio += item.FillingRation;
            }
            foreach (var demon in demons)
            {
                totalFillingRatio += demon.FillinRatio;
            }
            return totalFillingRatio;
        }

        private void Move(Player player, Position MoveToPos)
        {
            double totalFillingRatio = GetTotalFillingRatio(MoveToPos);
            if (totalFillingRatio + player.FillingRatio <= 1.0)
            {
                player.Pos = MoveToPos;
            }
        }

        private void Move(Demon demon, Position MoveToPos)
        {
            double totalFillingRatio = GetTotalFillingRatio(MoveToPos);
            if (totalFillingRatio + demon.FillinRatio <= 1.0)
            {
                demon.Pos = MoveToPos;
            }
        }

        private void DemonMoveLogic(Demon demon)
        {
            bool validMove = true;
            Position targetPosition = demon.Pos;
            while (validMove)
            {
                int x = demon.Pos.PosX + RNG.Next(-1, 2); // -1, 0, 1
                int y = demon.Pos.PosY + RNG.Next(-1, 2);
                if (x < 0 || x >= Console.WindowWidth ||
                    y < 0 || y >= Console.WindowHeight - 1)
                {
                    targetPosition = new Position(x, y);
                    validMove = false;
                }
            }
            Move(demon, targetPosition);
        }

        private void UpdateDemons()
        {
            foreach (var demon in this.Demons)
            {
                demon.UpdateState(this.Player);
                if (demon.State == DemonStateType.Move)
                {
                    DemonMoveLogic(demon);
                }
            }
        }

        private void RenderUI()
        {
            int uiRow = Console.WindowHeight - 1; // UI at bottom of screen
            
            // Save current cursor position and colors
            var originalBg = Console.BackgroundColor;
            var originalFg = Console.ForegroundColor;
            
            // Render HP
            Console.SetCursorPosition(0, uiRow);
            Console.BackgroundColor = ConsoleColor.Black;
            Console.ForegroundColor = ConsoleColor.Red;
            Console.Write($"HP: {Player.HitPoint} ");
            
            // Render Ammo
            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.Write($"AMMO: {Player.Ammo} ");
            
            // Render BFG Cells if needed
            Console.ForegroundColor = ConsoleColor.Green;
            Console.Write($"BFG: {Player.BFGCells}");
            
            // Restore original colors
            Console.BackgroundColor = originalBg;
            Console.ForegroundColor = originalFg;
        }

        public void Run()
        {
            while (!this.Exited)
            {
                RenderGame();
                RenderUI();
                UpdateDemons();
                UserAction();
                CleanUpGameItems();
                CleanUpDemons();
                Thread.Sleep(25);
            }
        }


    }
}   
